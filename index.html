<!doctype html>
<html lang="th" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏±‡∏ö-‡∏™‡πà‡∏á‡πÄ‡∏ß‡∏£ ‡∏ù‡πà‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Prompt', sans-serif; }
        .flower { position: fixed; top: -50px; z-index: 1000; pointer-events: none; animation: fall linear infinite; opacity: 0.6; }
        @keyframes fall { 0% { transform: translateY(-50px) rotate(0deg); opacity: 0.8; } 100% { transform: translateY(100vh) rotate(360deg); opacity: 0; } }
        .card-3d { background: white; border-radius: 1.5rem; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1); }
        .btn-hover:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .shift-btn.active { border-color: #ec4899; background-color: #fdf2f8; border-width: 3px; transform: scale(1.02); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dropdown-content { max-height: 250px; overflow-y: auto; z-index: 50; border-radius: 1rem; border: 1px solid #e2e8f0; }
    </style>
</head>
<body class="h-full bg-slate-50 text-slate-800">

    <script>
        // Web App URL ‡∏à‡∏≤‡∏Å Google Apps Script ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏°‡∏•‡∏ó‡∏¥‡∏£‡∏≤
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwy41jwqOjatNpmwUfakzlw3lLgPu9t97SfOEc6lRFq0djg3aQa4hIg5d5QsotSLKC6Xw/exec"; 
    </script>

    <div id="app" class="min-h-full">
        <!-- Home Page -->
        <div id="home-page" class="min-h-screen flex flex-col items-center justify-center p-6">
            <div class="text-center space-y-4 mb-10">
                <div class="text-8xl animate-bounce">üë©‚Äç‚öïÔ∏è</div>
                <h1 class="text-3xl md:text-5xl font-bold bg-gradient-to-r from-pink-500 to-violet-600 bg-clip-text text-transparent">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏±‡∏ö-‡∏™‡πà‡∏á‡πÄ‡∏ß‡∏£</h1>
                <p class="text-slate-500">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ù‡πà‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</p>
            </div>
            <div class="w-full max-w-sm space-y-4">
                <button onclick="showPage('form-page')" class="btn-hover w-full py-5 bg-pink-500 text-white rounded-2xl font-bold text-xl shadow-lg transition-all flex items-center justify-center gap-3">
                    <span>üìã</span> ‡∏•‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤
                </button>
                <button onclick="showPage('admin-login')" class="btn-hover w-full py-5 bg-white text-slate-600 border border-slate-200 rounded-2xl font-bold text-xl shadow-sm transition-all flex items-center justify-center gap-3">
                    <span>üîê</span> Admin Dashboard
                </button>
            </div>
        </div>

        <!-- Form Page -->
        <div id="form-page" class="hidden min-h-screen p-4 md:p-8">
            <div class="max-w-xl mx-auto">
                <div class="flex items-center gap-4 mb-8">
                    <button onclick="showPage('home-page')" class="p-3 bg-white rounded-full shadow-md hover:bg-slate-50 transition-all">üè†</button>
                    <h2 class="text-2xl font-bold text-slate-700">‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
                </div>

                <div class="card-3d p-6 md:p-8 space-y-6">
                    <!-- Unit Search -->
                    <div class="space-y-2 relative">
                        <label class="font-semibold text-slate-600">üè• ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)</label>
                        <input type="text" id="unit-search-input" onfocus="handleUnitSearch(this.value)" oninput="handleUnitSearch(this.value)" placeholder="‡πÄ‡∏ä‡πà‡∏ô RA5NE, SDICU..." autocomplete="off" class="w-full p-4 rounded-xl border border-slate-200 focus:ring-2 focus:ring-pink-500 outline-none">
                        <div id="unit-dropdown" class="hidden absolute top-full left-0 right-0 mt-1 bg-white border border-slate-200 shadow-xl dropdown-content"></div>
                        <input type="hidden" id="selected-unit-value">
                    </div>

                    <div class="space-y-2">
                        <label class="font-semibold text-slate-600">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πà‡∏á‡πÄ‡∏ß‡∏£</label>
                        <input type="date" id="start-date" class="w-full p-4 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-pink-500">
                    </div>

                    <div class="space-y-2">
                        <label class="font-semibold text-slate-600">‚è∞ ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÄ‡∏ß‡∏£</label>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="setShift('‡πÄ‡∏ä‡πâ‡∏≤‡∏™‡πà‡∏á‡∏ö‡πà‡∏≤‡∏¢')" class="shift-btn border-2 p-3 rounded-xl flex flex-col items-center hover:bg-slate-50 transition-all" id="btn-m">
                                <span class="text-2xl">üåÖ</span><span class="text-[10px] md:text-xs">‡πÄ‡∏ä‡πâ‡∏≤-‡∏ö‡πà‡∏≤‡∏¢</span>
                            </button>
                            <button onclick="setShift('‡∏ö‡πà‡∏≤‡∏¢‡∏™‡πà‡∏á‡∏î‡∏∂‡∏Å')" class="shift-btn border-2 p-3 rounded-xl flex flex-col items-center hover:bg-slate-50 transition-all" id="btn-a">
                                <span class="text-2xl">üåÜ</span><span class="text-[10px] md:text-xs">‡∏ö‡πà‡∏≤‡∏¢-‡∏î‡∏∂‡∏Å</span>
                            </button>
                            <button onclick="setShift('‡∏î‡∏∂‡∏Å‡∏™‡πà‡∏á‡πÄ‡∏ä‡πâ‡∏≤')" class="shift-btn border-2 p-3 rounded-xl flex flex-col items-center hover:bg-slate-50 transition-all" id="btn-n">
                                <span class="text-2xl">üåô</span><span class="text-[10px] md:text-xs">‡∏î‡∏∂‡∏Å-‡πÄ‡∏ä‡πâ‡∏≤</span>
                            </button>
                        </div>
                        <input type="hidden" id="selected-shift">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="font-semibold text-slate-600">‚ñ∂Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πà‡∏á‡πÄ‡∏ß‡∏£</label>
                            <input type="time" id="start-time" class="w-full p-4 rounded-xl border border-slate-200 outline-none">
                        </div>
                        <div class="space-y-2">
                            <label class="font-semibold text-slate-600">‚èπÔ∏è ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</label>
                            <input type="time" id="end-time" class="w-full p-4 rounded-xl border border-slate-200 outline-none">
                        </div>
                    </div>

                    <!-- End Date for Afternoon Shift -->
                    <div id="end-date-container" class="space-y-2 hidden">
                        <label class="font-semibold text-pink-600">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô (‡∏Å‡∏£‡∏ì‡∏µ‡∏™‡πà‡∏á‡πÄ‡∏ß‡∏£‡∏Ç‡πâ‡∏≤‡∏°‡∏ß‡∏±‡∏ô)</label>
                        <input type="date" id="end-date" class="w-full p-4 rounded-xl border-2 border-pink-100 outline-none">
                    </div>

                    <div class="space-y-2">
                        <label class="font-semibold text-slate-600">üìù Note / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                        <textarea id="note" rows="2" class="w-full p-4 rounded-xl border border-slate-200 outline-none" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
                    </div>

                    <button onclick="handleSubmit()" id="btn-submit" class="w-full py-4 bg-gradient-to-r from-pink-500 to-violet-500 text-white rounded-xl font-bold text-lg shadow-lg hover:opacity-90 transition-all">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚ú®</button>
                </div>
            </div>
        </div>

        <!-- Admin Login -->
        <div id="admin-login" class="hidden min-h-screen flex flex-col items-center justify-center p-6">
            <div class="card-3d p-8 w-full max-sm:max-w-xs text-center space-y-6">
                <div class="text-6xl">üîê</div>
                <h2 class="text-2xl font-bold">Admin Dashboard</h2>
                <input type="password" id="admin-pass" class="w-full p-4 rounded-xl border border-slate-200 text-center text-2xl tracking-widest outline-none" placeholder="****">
                <button onclick="handleLogin()" class="w-full py-4 bg-slate-800 text-white rounded-xl font-bold">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                <button onclick="showPage('home-page')" class="text-slate-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="dashboard-page" class="hidden min-h-screen p-4 md:p-8 space-y-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div class="flex items-center gap-3">
                    <button onclick="showPage('home-page')" class="p-2 bg-white rounded-full shadow-sm">üè†</button>
                    <h1 class="text-2xl font-bold text-slate-800">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö-‡∏™‡πà‡∏á‡πÄ‡∏ß‡∏£</h1>
                </div>
                <div class="flex gap-2 w-full md:w-auto">
                    <button onclick="syncFromSheet()" class="flex-1 md:flex-none px-4 py-2 bg-pink-500 text-white rounded-lg text-sm font-medium flex items-center justify-center gap-2">üîÑ Sync ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà</button>
                    <button onclick="exportToCSV()" class="flex-1 md:flex-none px-4 py-2 bg-green-500 text-white rounded-lg text-sm font-medium">Export CSV</button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center">
                <div class="card-3d p-5 flex flex-col border-b-4 border-pink-400">
                    <span class="text-slate-400 text-xs">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏ï‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                    <span id="stat-total" class="text-3xl font-bold">0</span>
                </div>
                <div class="card-3d p-5 flex flex-col border-b-4 border-violet-400">
                    <span class="text-slate-400 text-xs">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</span>
                    <span id="stat-units" class="text-3xl font-bold">0</span>
                </div>
                <div class="card-3d p-5 flex flex-col border-b-4 border-orange-400">
                    <span class="text-slate-400 text-xs">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏ô‡∏≤‡∏ó‡∏µ)</span>
                    <span id="stat-avg" class="text-3xl font-bold text-orange-500">0</span>
                </div>
                <div class="card-3d p-5">
                    <select id="filter-shift" onchange="refreshDashboard()" class="w-full p-2 border rounded-lg text-xs md:text-sm mt-2 outline-none">
                        <option value="">‡∏Å‡∏£‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏ß‡∏£ (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</option>
                        <option>‡πÄ‡∏ä‡πâ‡∏≤‡∏™‡πà‡∏á‡∏ö‡πà‡∏≤‡∏¢</option>
                        <option>‡∏ö‡πà‡∏≤‡∏¢‡∏™‡πà‡∏á‡∏î‡∏∂‡∏Å</option>
                        <option>‡∏î‡∏∂‡∏Å‡∏™‡πà‡∏á‡πÄ‡∏ä‡πâ‡∏≤</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 card-3d p-6 space-y-4">
                    <h3 class="font-bold flex items-center gap-2"><span>üìä</span> 20 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</h3>
                    <div id="bar-chart-container" class="h-96 overflow-y-auto space-y-3 pr-2"></div>
                </div>
                <div class="space-y-6">
                    <div class="card-3d p-6 border-l-8 border-red-400">
                        <h3 class="font-bold text-red-600 mb-4">üê¢ 10 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÄ‡∏ß‡∏£‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</h3>
                        <div id="slow-list" class="space-y-2 text-sm"></div>
                    </div>
                    <div class="card-3d p-6 border-l-8 border-green-400">
                        <h3 class="font-bold text-green-600 mb-4">üöÄ 10 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÄ‡∏ß‡∏£‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</h3>
                        <div id="fast-list" class="space-y-2 text-sm"></div>
                    </div>
                </div>
            </div>

            <div class="card-3d p-6 overflow-hidden">
                <div class="flex flex-col md:flex-row justify-between mb-4 gap-4">
                    <h3 class="font-bold">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡∏à‡∏≤‡∏Å Google Sheets</h3>
                    <input type="text" id="search-unit" oninput="refreshDashboard()" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô..." class="p-2 border rounded-lg text-sm w-full md:w-64 outline-none focus:border-pink-300">
                </div>
                <div class="overflow-x-auto rounded-xl border border-slate-100">
                    <table class="w-full text-left text-sm min-w-[650px]">
                        <thead class="bg-slate-50 text-slate-500 uppercase">
                            <tr>
                                <th class="p-4">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</th>
                                <th class="p-4">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th class="p-4">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏ß‡∏£</th>
                                <th class="p-4">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</th>
                                <th class="p-4 text-center">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ô‡∏≤‡∏ó‡∏µ)</th>
                                <th class="p-4">Note</th>
                            </tr>
                        </thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full bg-slate-800 text-white shadow-2xl opacity-0 transition-all pointer-events-none z-[2000] text-center max-w-[90%]"></div>

    <script>
        const UNITS = [
            'RAOFM', 'RAOCC', 'RAOAM', 'RAOPH', 'RAOPS', 'RAECT', 'RAOGY', 'RAOOB', 'RAORH', 'RAOER',
            'RAOOU', 'RAARU', 'RAOGP', 'SDOMD', 'SDODM', 'SDOET', 'SDOSU', 'SDORP', 'SDOEY', 'SDOIU',
            'SDOSP', 'SDPMD', 'SDPOS', 'SDPOG', 'SDPPD', 'SDPEY', 'SDPET', 'SDPDS', 'SDPPS', 'QSPCM',
            'RHPK', 'RA5NE', 'RA5SE', 'RA5SW', 'RA9SE', 'RA4TW', 'RA2TP', 'RA2TC', 'RA1RH', 'RA4NE',
            'RA4NW', 'RA6SW', 'RA3NW', 'RA6NW', 'RA6NE', 'RAHSU1', 'RA6SE', 'RA7SW', 'RA7SE', 'RA9SW',
            'RA7NE', 'RA1OW', 'RA2OW', 'RA3OW', 'QSPSY', 'RARPU', 'QSIPD71', 'QSIPD72', 'QSIPD81',
            'QSIPD82', 'QSIPD91', 'QSIPD92', 'QSIPD93', 'SDIPD62', 'SDIPD63', 'SDIPD64', 'SDIPD65',
            'SDIPD72', 'SDIPD73', 'SDIPD74', 'SDIPD75', 'SDIPD76', 'SDIPD81', 'SDIPD82', 'SDIPD83',
            'SDIPD85', 'SDIPD86', 'SDNS61', 'SDIPD96', 'RAOPD', 'RA8SE', 'RA8NW', 'RA4SP', 'RA8SW',
            'RA8NE', 'RA8IC', 'RA9PC', 'RA8NC', 'RA9NE', 'RA1TI', 'RA3IC', 'QS4IC', 'RA4IT', 'RA5IC',
            'RA5NB', 'RA5NW', 'SDICU51', 'SDHD', 'SDCCU91', 'SDICU92', 'SDICU95', 'QSICU8', 'QSVA04',
            'RA9IC', 'RA9CC', 'RA7NW', 'RAASU', 'QSHD5', 'SDNICU6', 'RAXSU', 'RAXRP', 'RAXET', 'RAXEY',
            'RAXGY', 'RAXRR', 'QSXSK', 'RALR4', 'SDLR6', 'SDOR5', 'RASCU', 'RAHHC1', 'SDHHC2', 'RASSS1',
            'SDSSS2', 'SDLMB', 'SDHCC', 'SDNC', 'SDIVN', 'QSTC', 'RAHTU', 'PCU'
        ];

        let rawData = [];
        let currentShift = "";

        function showPage(p) {
            document.querySelectorAll('#app > div').forEach(d => d.classList.add('hidden'));
            document.getElementById(p).classList.remove('hidden');
            window.scrollTo(0,0);
        }

        function showToast(m) {
            const t = document.getElementById('toast');
            t.textContent = m; t.classList.remove('opacity-0');
            setTimeout(() => t.classList.add('opacity-0'), 4000);
        }

        function handleUnitSearch(v) {
            const d = document.getElementById('unit-dropdown');
            const f = UNITS.filter(u => u.toLowerCase().includes(v.toLowerCase()));
            if(f.length > 0) {
                d.innerHTML = f.map(u => `<div onclick="selectUnit('${u}')" class="p-4 hover:bg-pink-50 cursor-pointer border-b border-slate-50 transition-colors">${u}</div>`).join('');
                d.classList.remove('hidden');
            } else { 
                d.innerHTML = '<div class="p-4 text-slate-400 italic">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏û‡∏¥‡∏°‡∏û‡πå</div>'; 
                d.classList.remove('hidden'); 
            }
        }

        function selectUnit(u) {
            document.getElementById('unit-search-input').value = u;
            document.getElementById('selected-unit-value').value = u;
            document.getElementById('unit-dropdown').classList.add('hidden');
        }

        function setShift(s) {
            currentShift = s; 
            document.getElementById('selected-shift').value = s;
            document.querySelectorAll('.shift-btn').forEach(b => b.classList.remove('active'));
            const id = s==='‡πÄ‡∏ä‡πâ‡∏≤‡∏™‡πà‡∏á‡∏ö‡πà‡∏≤‡∏¢'?'btn-m':s==='‡∏ö‡πà‡∏≤‡∏¢‡∏™‡πà‡∏á‡∏î‡∏∂‡∏Å'?'btn-a':'btn-n';
            document.getElementById(id).classList.add('active');

            const con = document.getElementById('end-date-container');
            if(s==='‡∏ö‡πà‡∏≤‡∏¢‡∏™‡πà‡∏á‡∏î‡∏∂‡∏Å') { 
                con.classList.remove('hidden'); 
                document.getElementById('end-date').value = document.getElementById('start-date').value;
            } else { 
                con.classList.add('hidden'); 
                document.getElementById('end-date').value = "";
            }
        }

        function formatTime24(timeStr) {
            if (!timeStr) return '-';
            if (String(timeStr).includes('T')) {
                const date = new Date(timeStr);
                if (isNaN(date.getTime())) return timeStr;
                const hours = date.getHours().toString().padStart(2, '0');
                const mins = date.getMinutes().toString().padStart(2, '0');
                return `${hours}:${mins}`;
            }
            if (String(timeStr).includes(':')) {
                const parts = timeStr.split(':');
                if (parts.length >= 2) {
                    return `${parts[0].padStart(2, '0')}:${parts[1].padStart(2, '0')}`;
                }
            }
            return timeStr;
        }

        async function handleSubmit() {
            const unit = document.getElementById('selected-unit-value').value;
            const startDate = document.getElementById('start-date').value;
            const endDateInput = document.getElementById('end-date').value;
            const shift = document.getElementById('selected-shift').value;
            const startTime = document.getElementById('start-time').value;
            const endTime = document.getElementById('end-time').value;
            const note = document.getElementById('note').value;

            if(!unit || !startDate || !shift || !startTime || !endTime) { 
                showToast("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"); 
                return; 
            }

            const finalEndDate = endDateInput || startDate;
            const startDt = new Date(`${startDate}T${startTime}`);
            const endDt = new Date(`${finalEndDate}T${endTime}`);
            let duration = Math.floor((endDt - startDt)/(1000*60));
            if(duration < 0) duration += 1440;

            const btn = document.getElementById('btn-submit');
            btn.disabled = true; btn.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Google Sheet...";

            const payload = { unit, startDate, endDate: finalEndDate, shift, startTime, endTime, durationMinutes: duration, note };

            try {
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                showToast("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheet ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞!");
                resetForm();
                setTimeout(() => showPage('home-page'), 2000);
            } catch (e) { 
                console.error(e);
                showToast("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ"); 
            } finally { 
                btn.disabled = false; btn.textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚ú®"; 
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Sync ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î Cache
        async function syncFromSheet() {
            showToast("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Google Sheets...");
            
            // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πâ‡∏≤‡∏á‡πÉ‡∏ô UI
            rawData = [];
            refreshDashboard();

            try {
                // ‡πÄ‡∏û‡∏¥‡πà‡∏° timestamp ‡∏ó‡πâ‡∏≤‡∏¢ URL ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô browser ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏≤‡∏Å cache (Cache Buster)
                const cacheBuster = "t=" + new Date().getTime();
                const separator = GOOGLE_SCRIPT_URL.includes('?') ? '&' : '?';
                const finalUrl = GOOGLE_SCRIPT_URL + separator + cacheBuster;

                const res = await fetch(finalUrl);
                const data = await res.json();
                
                rawData = data;
                refreshDashboard();
                showToast("‚ú® ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞");
            } catch (e) { 
                console.error(e);
                showToast("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á"); 
            }
        }

        function refreshDashboard() {
            const shiftF = document.getElementById('filter-shift').value;
            const searchF = document.getElementById('search-unit').value.toLowerCase();
            let data = [...rawData];

            if(shiftF) data = data.filter(d => d.shift === shiftF);
            if(searchF) data = data.filter(d => d.unit.toLowerCase().includes(searchF));

            document.getElementById('stat-total').textContent = data.length;
            document.getElementById('stat-units').textContent = [...new Set(data.map(d => d.unit))].length;
            const totalDur = data.reduce((s, d) => s + (Number(d.durationMinutes)||0), 0);
            document.getElementById('stat-avg').textContent = data.length > 0 ? (totalDur/data.length).toFixed(1) : 0;

            renderCharts(data); 
            renderRankings(data); 
            renderTable(data);
        }

        function renderCharts(data) {
            const counts = {}; 
            data.forEach(d => counts[d.unit] = (counts[d.unit]||0)+1);
            const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0, 20);
            const con = document.getElementById('bar-chart-container');
            
            if(sorted.length===0) { 
                con.innerHTML = '<div class="text-slate-300 italic text-center py-20">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</div>'; 
                return; 
            }
            const max = sorted[0][1];
            con.innerHTML = sorted.map(([u, c]) => `
                <div class="space-y-1">
                    <div class="flex justify-between text-[10px] md:text-xs">
                        <span class="font-medium">${u}</span>
                        <span class="text-slate-400">${c} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
                    </div>
                    <div class="w-full bg-slate-100 rounded-full h-3">
                        <div class="bg-gradient-to-r from-pink-400 to-violet-400 h-3 rounded-full transition-all duration-1000" style="width: ${(c/max*100)}%"></div>
                    </div>
                </div>
            `).join('');
        }

        function renderRankings(data) {
            const stats = {};
            data.forEach(d => {
                if(!stats[d.unit]) stats[d.unit] = {sum:0, count:0};
                stats[d.unit].sum += Number(d.durationMinutes);
                stats[d.unit].count += 1;
            });
            const avgs = Object.entries(stats).map(([u, s]) => ({ u, avg: (s.sum/s.count).toFixed(1) }));
            
            const slow = [...avgs].sort((a,b)=>b.avg-a.avg).slice(0, 10);
            document.getElementById('slow-list').innerHTML = slow.map(s => `<div class="flex justify-between p-2 rounded bg-red-50 text-[11px] md:text-sm"><span>${s.u}</span><span class="font-bold text-red-600">${s.avg} ‡∏ô‡∏≤‡∏ó‡∏µ</span></div>`).join('') || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
            
            const fast = [...avgs].sort((a,b)=>a.avg-b.avg).slice(0, 10);
            document.getElementById('fast-list').innerHTML = fast.map(s => `<div class="flex justify-between p-2 rounded bg-green-50 text-[11px] md:text-sm"><span>${s.u}</span><span class="font-bold text-green-600">${s.avg} ‡∏ô‡∏≤‡∏ó‡∏µ</span></div>`).join('') || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
        }

        function renderTable(data) {
            const tableData = [...data].reverse();
            document.getElementById('table-body').innerHTML = tableData.map(d => `
                <tr class="border-b hover:bg-slate-50 transition-colors">
                    <td class="p-4 font-semibold text-slate-700">${d.unit}</td>
                    <td class="p-4 text-slate-500 text-xs">${d.startDate}</td>
                    <td class="p-4">
                        <span class="px-2 py-0.5 rounded-full text-[9px] font-bold ${d.shift==='‡πÄ‡∏ä‡πâ‡∏≤‡∏™‡πà‡∏á‡∏ö‡πà‡∏≤‡∏¢'?'bg-orange-100 text-orange-600':d.shift==='‡∏ö‡πà‡∏≤‡∏¢‡∏™‡πà‡∏á‡∏î‡∏∂‡∏Å'?'bg-indigo-100 text-indigo-600':'bg-slate-800 text-white'}">
                            ${d.shift}
                        </span>
                    </td>
                    <td class="p-4 text-slate-500 text-xs">${formatTime24(d.startTime)} - ${formatTime24(d.endTime)}</td>
                    <td class="p-4 text-pink-600 font-bold text-center">${d.durationMinutes}</td>
                    <td class="p-4 text-slate-400 text-[10px] italic truncate max-w-[150px]" title="${d.note}">${d.note || '-'}</td>
                </tr>
            `).join('');
        }

        function resetForm() {
            document.getElementById('unit-search-input').value = ""; 
            document.getElementById('selected-unit-value').value = "";
            document.getElementById('start-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('selected-shift').value = ""; 
            document.getElementById('note').value = "";
            document.querySelectorAll('.shift-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('end-date-container').classList.add('hidden');
        }

        function handleLogin() { 
            if(document.getElementById('admin-pass').value === '0079') { 
                showPage('dashboard-page'); 
                // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö Sync ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà Login
                syncFromSheet(); 
            } else {
                showToast("‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á"); 
            }
        }

        function exportToCSV() {
            if(rawData.length===0) return;
            const head = ["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô", "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°", "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏ß‡∏£", "‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°", "‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö", "‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤(‡∏ô‡∏≤‡∏ó‡∏µ)", "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏"];
            const csv = "\uFEFF" + head.join(",") + "\n" + rawData.map(d => [d.unit, d.startDate, d.endDate, d.shift, d.startTime, d.endTime, d.durationMinutes, `"${d.note}"`].join(",")).join("\n");
            const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
            const link = document.createElement("a"); 
            link.href = URL.createObjectURL(blob); 
            link.download = `handover_report_${new Date().toISOString().split('T')[0]}.csv`; 
            link.click();
        }

        document.getElementById('start-date').value = new Date().toISOString().split('T')[0];
        
        function createFlowers() {
            const emojis = ['üå∏', 'üå∑', 'üå∫', 'üåº'];
            setInterval(() => {
                const f = document.createElement('div');
                f.className = 'flower';
                f.textContent = emojis[Math.floor(Math.random()*emojis.length)];
                f.style.left = Math.random() * 100 + 'vw';
                f.style.fontSize = (Math.random() * 20 + 10) + 'px';
                f.style.animationDuration = (Math.random() * 3 + 5) + 's';
                document.body.appendChild(f);
                setTimeout(() => f.remove(), 8000);
            }, 1000);
        }
        createFlowers();

        window.onclick = function(event) {
            if (!event.target.matches('#unit-search-input')) {
                document.getElementById('unit-dropdown').classList.add('hidden');
            }
        }
    </script>
</body>
</html>
